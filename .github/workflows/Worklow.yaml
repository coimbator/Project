name: GitHub Actions Workflow
run-name: ${{ github.actor }} workflow with shared Azure login
on: [push]

jobs:
  multiStageJob:
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository
      - name: Clone repository code
        uses: actions/checkout@v4

      # Azure login (common step)
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: '${{ secrets.AZURE_CREDENTIALS }}'

      # Set up Azure ML CLI extension (common for Azure ML tasks)
      - name: Install Azure ML extension
        run: |
          az extension add -n ml -y
          az extension update -n ml

      # Stage 1: Upload Dataset
      - name: Upload dataset to Azure ML
        run: |
          az ml data create --name <dataset-name> \
            --path HAR1 \
            --type uri_file \
            --workspace-name Project-WS \
            --resource-group Project-G \
            --description "Dataset uploaded via GitHub Actions"

      # Stage 2: Submit Azure ML Job
      - name: Submit Azure ML job
        run: |
          az ml job create --file job.yaml \
            --workspace-name Project-WS \
            --resource-group Project-G

      # Stage 3: Query Azure ML Data
      - name: Query Azure ML data asset
        run: |
          az ml data list --workspace-name Project-WS \
            --resource-group Project-G \
            --output table

